image: node:8.17.0

definitions:
  caches:
    apt: /var/cache/apt

pipelines:
  custom: # Pipelines that are triggered manually
    build_js:
    #build_zip:
#  tags:
#    '*':
      - step:
          name: "Build the JS module and download zip"
          caches:
            - apt
            - node
          script:
            - apt-get update && apt-get -qq install zip rsync
            - mkdir -p /tmp/iaparent/integrityadvocate
            - rsync -av ./ /tmp/iaparent/integrityadvocate --exclude *.pl --exclude *.zip --exclude .git/ --exclude .gitignore --exclude Makefile --exclude bitbucket-pipelines.yml --exclude screenshots/ --exclude tests/
            - cd /tmp/iaparent/integrityadvocate

            - npm install
            - npm install grunt
            - npm install -g grunt-cli
            - grunt --verbose shifter

            - find ./ \( -type d -name .git -prune \) -o -type f -name '*.php' -print0 |  xargs -0 sed -i 's#$debug = true;#$debug = false;#g'
